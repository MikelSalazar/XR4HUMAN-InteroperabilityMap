export class NodeType{get name(){return this._name}get tag(){return this._tag}get serializable(){return this._serializable}get parent(){return this._parent}get children(){return this._children}get childCount(){return this._childCount}get childTags(){return this._childTags}get prototype(){return this._prototype}constructor(name,tag,parent,prototype){this._name=name;this._tag=tag||name.toLowerCase();this._parent=parent;this._children={};this._childCount=0;this._childTags={};if(parent){parent._children[name]=parent._childTags[tag]=this;parent._childCount++}this._prototype=prototype}is(typeName){if(this._name==typeName)return true;if(this._parent!=undefined&&this._parent.is(typeName))return true;return false}toString(){return this._name}}export class Node{get name(){return this._name}get type(){return this._type}get updated(){return this._updated}set updated(updated){updated=updated==true;if(!updated&&this._parent)this._parent.updated=false;this._updated=updated}get updateTime(){return this._updateTime}get debug(){return this._debug}set debug(d){this._debug=d}get id(){return(this._parent?this._parent.id+"/":"")+this._name}get parent(){return this._parent}get children(){return Object.values(this._children)}constructor(name,parent,data={},type=Node.type){this._name=name||data.name;if(!this._name||Node._specialKeys.includes(this._name))throw Error('Invalid node name "'+this.name+'"');this._type=type;if(!this._type)throw Error("Invalid node type for: "+this.id);this._children={};this._parent=parent;if(parent){if(parent._children[this._name])throw Error('Repeated key: "'+this._name+'" for '+parent.id);parent._children[this._name]=this;if(parent._updated)parent.updated=false}this._updated=false;this._debug=data.debug;if(this._debug)console.log("Created "+this._type.name+' "'+this.id+'"')}ancestor(type){let node=this.parent;while(node){if(node instanceof type)break;node=node.parent}return node}get(key){return this._children[key]}update(forced=false){if(this._updated&&!forced)return;this._updated=true;for(let child of this.children)if(!child.update(forced))this._updated=false;this._updateTime=Date.now();return this._updated}deserialize(data={}){if(data==undefined||typeof data!="object")return;this._debug=data.debug;for(let key in data){if(Node._specialKeys.includes(key))continue;if(this._children[key]!=undefined)this._children[key].deserialize(data[key]);else console.warn('Unknown child node "'+key+'" for'+this.id)}}serialize(params={}){let data={},itemCount=0;if(this._name)data.name=this._name;for(let key in this._children){let item=this._children[key].serialize(params);if(item==undefined)continue;data[key]=item;itemCount++}return params.optimize&&itemCount==0?undefined:data}toString(){return JSON.stringify(this.serialize())}[Symbol.iterator](){let pointer=0,items=Object.values(this._children);return{next(){if(pointer<items.length)return{done:false,value:items[pointer++]};else return{done:true,value:null}}}}}Node.type=new NodeType("Node","node",null,Node);Node._specialKeys=["name","debug","type"];export class NodeSet extends Node{get name(){return this._name}get type(){return this._type}get indexed(){return this._indexed}get keys(){return Object.keys(this._children)}get children(){return Object.values(this._children)}get count(){return this.children.length}get first(){return this.children[0]}get last(){return this.children[this.children.length-1]}constructor(name,parent,type,data){super(name,parent,undefined,NodeSet.type);if(!type)throw Error("Invalid node type for: "+this.id);this._type=type;if(data!=undefined)this.deserialize(data)}get(key){if(typeof key=="string")return this._children[key];else if(typeof key=="number"){let keys=window.Object.keys(this._children);if(key<0||key>keys.length)console.warn('Invalid index "'+key+'" for: '+this.id);return this._children[keys[key]]}else console.warn('Invalid index "'+key+'" for: '+this.id)}deserialize(data){if(data==undefined)return;if(Array.isArray(data)){this._indexed=true;let index=1;for(let item of data){let nodeType=this._type;if(item.type){nodeType=this._type.childTags[item.type];if(!nodeType)throw Error('Invalid type: "'+item.type+'" for: '+this.id)}new nodeType.prototype(""+index++,this,item)}}else if(typeof data=="object"){this._indexed=false;for(let key in data){let item=data[key],nodeType=this._type;if(item.type){nodeType=this._type.childTags[item.type];if(!nodeType)throw Error('Invalid type: "'+item.type+'" for: '+this.id)}new nodeType.prototype(key,this,item)}}else throw Error('Invalid data "'+data+'" for: '+this.id)}serialize(params={}){if(this._indexed==true){let array=[];let children=Object.values(this._children);for(let child of children)array.push(child.serialize());return array.length>0?array:undefined}else{let obj={},itemCount=0;for(let childName in this._children){let item=this._children[childName].serialize();if(item!=undefined){obj[childName]=item;itemCount++}}return itemCount>0?obj:undefined}}toString(){let text=JSON.stringify(this.serialize());return this.name+": "+(text?text:"[]")}[Symbol.iterator](){let pointer=0,items=Object.values(this._children);return{next(){if(pointer<items.length)return{done:false,value:items[pointer++]};else return{done:true,value:null}}}}}NodeSet.type=new NodeType("NodeSet","set",Node.type,NodeSet);export class NodeLink extends Node{get references(){return this._references}constructor(name,parent,data,origin,inverse){super(name,parent,undefined,NodeLink.type);this._origin=origin;this._inverse=inverse;this._references=[];if(data!=undefined)this.deserialize(data)}update(forced=false){if(this._updated&&!forced)return;this._children={};for(let reference of this._references){let node=this._origin.get(reference);if(!node)throw Error('Invalid reference "'+reference+'"'+" for: "+this.id);this._children[reference]=node;if(this._inverse){let inverseLink=node[this._inverse];if(!inverseLink)throw Error('Inverse link "'+this._inverse+'" not found in '+node.id);let inverseNode=this.parent;if(!inverseLink._children[inverseNode.name]){inverseLink._references.push(inverseNode.name);inverseLink._children[inverseNode.name]=inverseNode}}}return this._updated=true}deserialize(data){if(Array.isArray(data)){this._references=[];for(let reference of data)this._references.push(reference)}else throw Error("Invalid data for: "+this.id)}serialize(params={}){return this._references.length>0?this.references:undefined}}NodeLink.type=new NodeType("Link","link",null,NodeLink);export class Simple extends Node{get value(){return this._value!=undefined?this._value:this.default}set value(newValue){if(this._value==newValue)return;this._value=newValue;this.updated=false}get default(){return this._default}set default(newDefault){if(this._default==newDefault)return;this._default=newDefault;this.updated=false}get isUndefined(){return this._value==undefined}get isDefault(){return this.default!=undefined&&this._value==this._default}constructor(name,parent,data,type=Node.type,def){super(name,parent,data,type);this._default=def}deserialize(data){this.value=data}serialize(params={}){return this.value}toString(){return this.value!=undefined?this.value.toString():"(undefined)"}valueOf(){return this.value}}Simple.type=new NodeType("Simple","simple",null,Simple);export class Boolean extends Simple{constructor(name,parent,data,def){super(name,parent,undefined,Boolean.type,def);if(data!=undefined)this.deserialize(data)}deserialize(data){switch(typeof data){case"boolean":this.value=data==true;break;case"number":this.value=data!=0;break;case"string":this.value=data.toLowerCase()=="true";break;case"object":super.deserialize(data);if(data.default!=undefined)this.default=data.default;if(data.value!=undefined)this.value=data.value;break;default:this.value=data!=0;break}}}Boolean.type=new NodeType("Boolean","boolean",Node.type,Boolean);export class Number extends Simple{get value(){return this._value!=undefined?this._value:this.default}set value(newValue){if(this._value==newValue)return;if(this._min!=undefined&&newValue<this._min)throw Error("The minimum value for "+this.id+" is: "+this._min);if(this._max!=undefined&&newValue>this._max)throw Error("The maximum value for "+this.id+" is: "+this._max);this._value=newValue;this.updated=false}get min(){return this._min}set min(newMin){if(this._min==newMin)return;this._min=newMin;this.updated=false}get max(){return this._max}set max(newMax){if(this._max==newMax)return;this._max=newMax;this.updated=false}constructor(name,parent,data,def,min,max){super(name,parent,undefined,Number.type,def);if(min!=undefined)this._min=min;if(max!=undefined)this._max=max;if(data!=undefined)this.deserialize(data)}deserialize(data){switch(typeof data){case"boolean":this.value=data==true?1:0;break;case"number":this.value=data;break;case"string":this.value=parseFloat(data);break;case"object":super.deserialize(data);if(data.min!=undefined)this.min=data.min;if(data.max!=undefined)this.max=data.max;if(data.default!=undefined)this.default=data.default;if(data.value!=undefined)this.value=data.value;break;default:this.value=parseFloat(data);break}}toString(){if(this._value==undefined)return"(undefined)";let value=this.value.toString();if(value.includes("."))value=this.value.toFixed(5);return value}}Number.type=new NodeType("Number","number",Node.type,Number);export class String extends Simple{get value(){return this._value!=undefined?this._value:this.default}set value(newValue){if(this._value==newValue)return;if(this._options.length>0&&!this._options.includes(newValue))throw'Invalid value: "'+newValue+'" '+' valid value are: "'+this._options.join('", ,"')+'"';this._value=newValue;this.updated=false}get options(){return this._options}set options(newOptions){if(!Array.isArray(newOptions))return;this._options=[];for(let newValidValue of newOptions)this._options.push(newValidValue)}constructor(name,parent,data,def){super(name,parent,undefined,String.type,def);this._options=[];if(data!=undefined)this.deserialize(data)}deserialize(data){switch(typeof data){case"boolean":this.value=data==true?"true":"false";break;case"number":this.value=data.toString();break;case"string":this.value=data;break;case"object":if(data.validValues!=undefined)this.options=data.validValues;if(data.default!=undefined)this.default=data.default;if(data.value!=undefined)this.value=data.value;break;default:this.value=data.toString();break}}}String.type=new NodeType("String","string",Node.type,String);export class Complex extends Node{constructor(name,parent,data,type=Node.type,def){super(name,parent,data,type)}deserialize(data){let items=this.children,itemCount=items.length;if(Array.isArray(data)){for(let valueIndex=0;valueIndex<data.length;valueIndex++){if(valueIndex>itemCount)break;items[valueIndex].deserialize(data[valueIndex])}}else if(typeof data=="object"){super.deserialize(data);for(let key in data){if(!this._children[key])console.warn('Unknown child: "'+key+'" for: '+this.id);this._children[key].deserialize(data[key])}}else if(typeof data=="number"){for(let item of items)item.deserialize(data)}else throw Error('Invalid values: "'+data+'" for:'+this.id)}serialize(params={}){let result=[],items=this.children;for(let item of items){if(item.isUndefined)break;result.push(item.value)}return result}toString(){let valueStrings=[];for(let item of this){let itemString=item.toString();if(itemString=="(undefined)")break;valueStrings.push(item.toString())}return"["+valueStrings.join(", ")+"]"}}Complex.type=new NodeType("Complex","complex",null,Complex);export class Vector extends Complex{get x(){return this._x}get y(){return this._y}get z(){return this._z}get isUndefined(){return this._x.isUndefined&&this._y.isUndefined&&this._z.isUndefined}constructor(name,parent,data){super(name,parent,data);this._x=new Number("x",this,undefined,0);this._y=new Number("y",this,undefined,0);this._z=new Number("z",this,undefined,0);if(data!=undefined)this.deserialize(data)}getValues(x=0,y=0,z=0){return{x:this._x.value,y:this._y.value,z:this._z.value}}setValues(x=0,y=0,z=0){if(x!=undefined)this._x.value=x;if(y!=undefined)this._y.value=y;if(z!=undefined)this._z.value=z}addValues(x=0,y=0,z=0){if(x!=undefined)this._x.value+=x;if(y!=undefined)this._y.value+=y;if(z!=undefined)this._z.value+=z}subtractValues(x=0,y=0,z=0){if(x!=undefined)this._x.value+=x;if(y!=undefined)this._y.value+=y;if(z!=undefined)this._z.value+=z}static distance(v1,v2){let dx=(v1._x.value||0)-(v2._x.value||0),dy=(v1._y.value||0)-(v2._y.value||0),dz=(v1._z.value||0)-(v2._z.value||0);return Math.sqrt(dx*dx+dy*dy+dz*dz)}}Vector.type=new NodeType("Vector","vector",Complex.type,Vector);export class Color extends Complex{get r(){return this._r}get g(){return this._g}get b(){return this._b}get a(){return this._a}get text(){return this._text}get hex(){let r=Math.floor(this._r.value*255).toString(16).padStart(2,"0"),g=Math.floor(this._g.value*255).toString(16).padStart(2,"0"),b=Math.floor(this._b.value*255).toString(16).padStart(2,"0"),a=this._a.value==1?"":Math.floor(this._a.value*255).toString(16).padStart(2,"0");return"#"+r+g+b+a}set hex(v){try{this._text.value=undefined;if(v[0]=="#")v=v.slice(1);let charCount=v.length,short=charCount<5;if(charCount<3)throw Error("Wrong value");let r=parseInt(short?v[0]+v[0]:v[0]+v[1],16);this._r.value=r>0?r/255:0;let g=parseInt(short?v[1]+v[1]:v[2]+v[3],16);this._g.value=g>0?g/255:0;let b=parseInt(short?v[2]+v[2]:v[4]+v[5],16);this._b.value=b>0?b/255:0;if(!(charCount==4||charCount==8))return;let a=parseInt(short?v[3]+v[3]:v[6]+v[7],16);this._a.value=a>0?a/255:0}catch(e){throw Error('Invalid Hex value "'+v+'" for '+this.id)}}get isUndefined(){return this._r.isUndefined&&this._g.isUndefined&&this._b.isUndefined&&this._a.isUndefined}get isDefault(){return this._r.isDefault&&this._g.isDefault&&this._b.isDefault&&this._a.isDefault}constructor(name,parent,data){super(name,parent,data);this._r=new Number("r",this,undefined,0);this._g=new Number("g",this,undefined,0);this._b=new Number("b",this,undefined,0);this._a=new Number("a",this,undefined,1);this._text=new String("text",this);if(data!=undefined)this.deserialize(data)}deserialize(data){if(Array.isArray(data)){if(data.length>0)this._r.value=data[0];if(data.length>1)this._g.value=data[1];if(data.length>2)this._b.value=data[2];if(data.length>3)this._a.value=data[3]}else{let dataType=typeof data;if(typeof data=="object"){super.deserialize(data);if(data.r!=undefined)this._r.value=data.r;if(data.g!=undefined)this._g.value=data.g;if(data.b!=undefined)this._b.value=data.b;if(data.a!=undefined)this._a.value=data.a}else if(dataType=="number"){this._r.value=this._g.value=this._b.value=data}else if(dataType=="string"){if(data.startsWith("#"))this.hex=data;else this._text.value=data}else throw Error('Invalid value: "'+data.toString()+'" '+'of type"'+dataType+'" for: '+this.id)}}serialize(params={}){if(this.text.value)return this.text.value;let v=[this._r.value,this._g.value,this._b.value,this._a.value];if(v[0]==0&&v[1]==0&&v[2]==0&&v[3]==1)return undefined;if(v[3]==1)v.pop();return v}toString(){if(this.text.value)return this.text.value;else return this.hex}static interpolate(c1,c2,t){return new Color("color",undefined,[c1._r.value+(c2._r.value-c1._r.value)*t,c1._g.value+(c2._g.value-c1._g.value)*t,c1._b.value+(c2._b.value-c1._b.value)*t])}}Color.type=new NodeType("Color","color",Complex.type,Color);export class Item extends Node{get title(){return this._title}get description(){return this._description}constructor(name,parent,data,type=Item.type){super(name,parent,undefined,Item.type);this._title=new String("title",this);this._description=new String("description",this);if(data!=undefined)this.deserialize(data)}}Item.type=new NodeType("Item","item",Node.type,Item);export class Domain extends Item{get extends(){return this._extends}get classes(){return this._classes}constructor(name,parent,data){super(name,parent,undefined,Domain.type);let model=this.ancestor(Model);this._extends=new NodeLink("extends",this,undefined,model?model.domains:undefined);this._classes=new NodeLink("classes",this,undefined,model?model.classes:undefined,"domains");if(data!=undefined)this.deserialize(data)}}Domain.type=new NodeType("Domain","domain",Item.type,Domain);export class Class extends Item{get extends(){return this._extends}get domains(){return this._domains}get relations(){return this._relations}get properties(){return this._properties}get instances(){return this._instances}constructor(name,parent,data){super(name,parent,undefined,Class.type);let model=this.ancestor(Model);this._extends=new NodeLink("extends",this,undefined,model?model.classes:undefined);this._domains=new NodeLink("domains",this,undefined,model?model.domains:undefined,"classes");this._relations=new NodeLink("relations",this,undefined,model?model.relations:undefined,"classes");this._properties=new NodeSet("properties",this,Property.type);this._instances=new NodeSet("instances",this,ClassInstance.type);if(data!=undefined)this.deserialize(data)}}Class.type=new NodeType("Class","class",Item.type,Class);export class Property extends Item{constructor(name,parent,data){super(name,parent,undefined,Property.type);if(data!=undefined)this.deserialize(data)}}Property.type=new NodeType("Property","property",Item.type,Property);export class ClassInstance extends Item{get class(){return this._class}get properties(){return this._properties}constructor(name,parent,data){super(name,parent,undefined,ClassInstance.type);this._class=new NodeLink("class",this);this._properties=new NodeSet("properties",this,Property.type);if(data!=undefined)this.deserialize(data)}}ClassInstance.type=new NodeType("ClassInstance","class_instance",Item.type,ClassInstance);export class Relation extends Item{get extends(){return this._extends}get classes(){return this._classes}get instances(){return this._instances}constructor(name,parent,data){super(name,parent,undefined,Relation.type);let model=this.ancestor(Model);this._extends=new NodeLink("extends",this,undefined,model?model.relations:undefined);this._classes=new NodeLink("classes",this,undefined,model?model.classes:undefined,"relations");this._instances=new NodeSet("instances",this,RelationInstance.type);if(data!=undefined)this.deserialize(data)}}Relation.type=new NodeType("Relation","relation",Item.type,Relation);export class RelationInstance extends Item{get relation(){return this._relation}get origin(){return this._origin}get target(){return this._target}constructor(name,parent,data){super(name,parent,undefined,RelationInstance.type);this._relation=new NodeLink("relation",this);this._origin=new NodeLink("origin",this);this._target=new NodeLink("target",this);if(data!=undefined)this.deserialize(data)}}RelationInstance.type=new NodeType("RelationInstance","relation_instance",Item.type,RelationInstance);export class Model extends Node{get domains(){return this._domains}get classes(){return this._classes}get relations(){return this._relations}constructor(name,parent,data){super(name,parent);this._domains=new NodeSet("domains",this,Domain.type);this._classes=new NodeSet("classes",this,Class.type);this._relations=new NodeSet("relations",this,Relation.type);if(data!=undefined)this.deserialize(data)}}Model.type=new NodeType("Model","model",Node.type,Model);export class Easing{static linear(t){return t}static quadratic(t){return t*t}static cubic(t){return t*t*t}}export class Animation{constructor(target,property,startValue,endValue,startTime=0,endTime=1,autoplay=true,easing=Easing.quadratic){if(KnowledgeGraph.environment=="node")return;this._target=target;this._property=property;this._startValue=startValue;this._endValue=endValue;this._startTime=startTime;this._endTime=endTime;this._autoplay=autoplay;this._easing=easing;if(autoplay)this.play()}play(times=1,reverse=false){this._previousTime=undefined;this._reverse=reverse;this.update(document.timeline.currentTime.valueOf())}update(time){time/=1e3;if(this._previousTime==undefined)this._currentTime=-this._startTime;else this._currentTime+=time-this._previousTime;this._previousTime=time;let interpolation=0,duration=this._endTime-this._startTime,value,difference=this._endValue-this._startValue;if(this._currentTime<=0)interpolation=0;else if(this._currentTime<duration){interpolation=this._currentTime/duration;if(this._easing)interpolation=this._easing(interpolation)}else interpolation=1;if(this._reverse)interpolation=1-interpolation;value=this._startValue+difference*interpolation;if(typeof this._target=="function")this._target(interpolation,value);else if(this._property!=undefined)this._target.setAttribute(this._property,value);if(this._currentTime<this._endTime)requestAnimationFrame(this.update.bind(this))}}export class Component{get tag(){return this._tag}get width(){return this._width}set width(w){this._width=w}get height(){return this._height}set height(h){this._height=h}get content(){return this._content}set content(c){this._content=c;if(this._element)this._element.innerHTML=c}get enabled(){return this._enabled}set enabled(e){this._element.setAttribute("visibility",e?"visible":"hidden");this._enabled=e}get element(){return this._element}get parent(){return this._parent}get children(){return this._children}get animations(){return this._animations}get onclick(){return this._onclick}set onclick(listener){if(KnowledgeGraph.environment!="browser")return;this._onclick=listener;this._element.addEventListener("click",listener)}constructor(tag,parent,attributes,content,onclick){if(tag)this._tag=tag;else throw Error("Invalid SVG tag");if(KnowledgeGraph.environment=="browser"){if(attributes&&attributes.id)this._element=document.getElementById(attributes.id);if(!this._element)this._element=document.createElementNS("http://www.w3.org/2000/svg",tag);if(parent)parent._element.appendChild(this._element)}this._attributes={};let a=attributes;if(attributes!=undefined&&typeof attributes=="object"){for(let key in attributes)this.setAttribute(key,attributes[key])}this._animations={};if(content)this.content=content;else this._content="";if(onclick)this.onclick=onclick;this._parent=parent;this._children=[];if(parent!=undefined)parent._children.push(this)}getAttribute(name){return this._attributes[name]}setAttribute(name,value){if(typeof value=="number")value=Component.serializeNumber(value);if(name.indexOf("_")>=0)name=name.replace(/_/g,"-");this._attributes[name]=value;if(this._element){if(value!=undefined)this._element.setAttribute(name,value);else this._element.removeAttribute(name)}}bringToFront(){if(this._element&&this._element.parentNode){if(!this._element.nextElementSibling)return;let parentElement=this._element.parentNode;parentElement.removeChild(this._element);parentElement.appendChild(this._element)}}clear(){for(let child of this._children)child._element.remove();this._children=[]}static serializeNumber(value){let string=value.toFixed(5),point=string.indexOf("."),cursor=point+1,l=string.length;while(cursor>0&&cursor<l-1){if(string[cursor]=="0"&&string[cursor+1]=="0"){if(cursor==point+1)cursor=point;string=string.slice(0,cursor);break}cursor++}return string}toString(tabLevel=0){let result="\t".repeat(tabLevel)+"<"+this.tag;for(let key in this._attributes)result+=" "+key+'="'+this._attributes[key]+'"';if(this._content)return result+">"+this._content+"</"+this.tag+">";if(this._children.length==0)return result+"/>";result+=">";for(let child of this._children)result+="\n"+child.toString(tabLevel+1);return result+"\n"+"\t".repeat(tabLevel)+"</"+this.tag+">"}}export class Widget extends Node{get enabled(){return this._enabled}set enabled(e){this._enabled=e}get component(){return this._component}get width(){return this._width}get height(){return this._height}get anchor(){return this._anchor}get pivot(){return this._pivot}get position(){return this._position}get scale(){return this._scale}get widgets(){return this._widgets}constructor(name,parent,data,type=Widget.type){super(name,parent,data,type);this._width=new Number("width",this,undefined,0);this._height=new Number("height",this,undefined,0);this._anchor=new String("anchor",this,{validValues:Widget.anchorValues,default:"top-left"});this._pivot=new String("pivot",this,{validValues:Widget.pivotValues,default:"top-left"});this._position=new Vector("position",this);this._scale=new Number("scale",this,undefined,1,.1,10);this._widgets=new NodeSet("widgets",this,Widget.type);this._backgroundColor=new Color("background",this,"none");this._backgroundRadius=new Number("radius",this,0);let node=this.parent;while(node){let component=node.component;if(component){this._parentComponent=component;break}node=node.parent}if(!this._parentComponent)throw Error("No parent component for: "+this.id);this._component=new Component("g",this._parentComponent,{id:this.name});this._backgroundComponent=new Component("rect",this._component,{fill:"none"});this._enabled=true;this._dragEvents=false;if(data!=undefined)this.deserialize(data);let ui=this.ancestor(UserInterface);this.resize(ui.width.value,ui.height.value)}update(forced=false){if(this._updated&&!forced)return;let position=this.position.getValues(),scale=this._scale.value,x=position.x,y=position.y,w=this._width.value||0,h=this._height.value||0;this._offSetX=0;this._offSetY=0;switch(this._pivot.value){case"top":case"center":case"bottom":this._offSetX=w/2;break;case"top-right":case"right":case"bottom-right":this._offSetX=w;break}switch(this._pivot.value){case"left":case"center":case"right":this._offSetY=h/2;break;case"bottom-left":case"bottom":case"bottom-right":this._offSetY=h;break}if(this._offSetX!=0)x+=this._offSetX;if(this._offSetY!=0)y+=this._offSetY;if(!this._anchor.isDefault){let p=this.ancestor(Widget),pw=0,ph=0;if(p){pw=p.width.value;ph=p.height.value;x-=p._offSetX;y-=p._offSetY}switch(this._anchor.value){case"top":case"center":case"bottom":x+=(pw-w)/2;break;case"top-right":case"right":case"bottom-right":x+=pw-w;break}switch(this._anchor.value){case"left":case"center":case"right":y+=(ph-h)/2;break;case"bottom-left":case"bottom":case"bottom-right":y+=ph-h;break}if(this._anchor.value=="movable"){if(!this._dragEvents)this.enableDragEvents()}}if(x==0&&y==0&&scale==1)this._component.setAttribute("transform",undefined);else this._component.setAttribute("transform",(x!=0||y!=0?"translate("+x+" "+y+")":"")+" "+(scale!=1?"scale("+Component.serializeNumber(scale)+") ":""));if(this._offSetX!=0||this._offSetY!=0){this._backgroundComponent.setAttribute("x",-this._offSetX);this._backgroundComponent.setAttribute("y",-this._offSetY)}this._backgroundComponent.setAttribute("width",w);this._backgroundComponent.setAttribute("height",h);if(!this._backgroundColor.isDefault){this._backgroundComponent.setAttribute("fill",this._backgroundColor.toString())}else this._backgroundComponent.setAttribute("fill","none");if(!this._backgroundRadius.isDefault){this._backgroundComponent.setAttribute("rx",this._backgroundRadius.toString());this._backgroundComponent.setAttribute("ry",this._backgroundRadius.toString())}else{this._backgroundComponent.setAttribute("rx",undefined);this._backgroundComponent.setAttribute("ry",undefined)}return super.update()}resize(width,height){if(!this._width.isUndefined)width=this._width.value;if(!this._height.isUndefined)height=this._height.value;this._component.width=width;this._component.height=height;this._width.default=width;this._height.default=height;for(let child of this.widgets)child.resize(width,height);this.updated=false;let x1=0,x2=width,y1=0,y2=height;switch(this._pivot.value){case"top":case"center":case"bottom":x1-=width/2;x2-=width/2;break;case"top-right":case"right":case"bottom-right":x1-=width;x2-=width;break}switch(this._pivot.value){case"left":case"center":case"right":y1-=height/2;y2-=height/2;break;case"bottom-left":case"bottom":case"bottom-right":y1-=height;y2-=height;break}if(this.debug){let cellSize=100;if(!this._debugComponent)this._debugComponent=new Component("g",this._component,{id:"debug",fill:"none"});this._debugComponent.clear();new Component("rect",this._debugComponent,{x:x1,y:y1,width:width,height:height,stroke:"grey"});let x1c=Math.ceil(x1/cellSize)*cellSize,x2c=Math.floor(x2/cellSize)*cellSize,y1c=Math.ceil(y1/cellSize)*cellSize,y2c=Math.floor(y2/cellSize)*cellSize;for(let x=x1c;x<=x2c;x+=cellSize)new Component("line",this._debugComponent,{y1:y1,y2:y2,x1:x,x2:x,stroke:x==0?"green":"grey"});for(let y=y1c;y<=y2c;y+=cellSize)new Component("line",this._debugComponent,{x1:x1,x2:x2,y1:y,y2:y,stroke:y==0?"red":"grey"});console.log("Resized "+this.id+": "+width+" x "+height)}}enableDragEvents(){let ui=this.ancestor(UserInterface);let element=ui.component.element;if(!element)return;element.addEventListener("mousedown",(e=>{this.react("down",e.buttons,e.offsetX,e.offsetY,e.movementX,e.movementY);e.preventDefault()}));window.addEventListener("mousemove",(e=>{this.react("move",e.buttons,e.offsetX,e.offsetY,e.movementX,e.movementY);e.preventDefault()}));element.addEventListener("mouseup",(e=>{this.react("up",e.buttons,e.offsetX,e.offsetY,e.movementX,e.movementY);e.preventDefault()}));element.addEventListener("wheel",(e=>{this.react("zoom",e.buttons,e.pageX-element.clientLeft,e.pageY-element.clientTop,e.movementX,e.movementY,e.deltaY<0?.1:-.1);e.preventDefault()}));let cursorX=0,cursorY=0,maxTouches=0;element.addEventListener("touchstart",(e=>{let touch=e.touches[0],touchCount=e.touches.length;cursorX=touch.clientX;cursorY=touch.clientY;this.react("down",touchCount,cursorX,cursorY);maxTouches=touchCount}));element.addEventListener("touchend",(e=>{let touch=e.touches[0],touchCount=e.touches.length,mx=touch.clientX-cursorX,my=touch.clientY-cursorY;cursorX=touch.clientX;cursorY=touch.clientY;this.react("up",touchCount,cursorX,cursorY,mx,my)}));let touchSeparation=undefined;element.addEventListener("touchmove",(e=>{if(e.touches.length<2){let touch=e.touches[0],touchCount=e.touches.length,mx=touch.clientX-cursorX,my=touch.clientY-cursorY;cursorX=touch.clientX;cursorY=touch.clientY;this.react("move",touchCount,cursorX,cursorY,mx,my);e.preventDefault()}else{let dx=e.touches[1].pageX-e.touches[0].pageX,dy=e.touches[1].pageY-e.touches[0].pageY,s=Math.sqrt(dx*dx+dy*dy)/100,x=e.touches[1].pageX-element.clientLeft-dx/2,y=e.touches[1].pageY-element.clientTop-dy/2;if(touchSeparation!=undefined)this.react("zoom",0,x,y,0,0,s-touchSeparation);touchSeparation=s}}));element.addEventListener("touchend",(e=>{touchSeparation=undefined}));this._dragEvents=true}react(action,button,x,y,mx,my,mz){if(!this._enabled)return;if(action=="move"){if(button>0)this._position.addValues(mx,my);return}if(action=="zoom"){let oldZoom=this._scale.value,newZoom=this._scale.value+mz;if(newZoom<this._scale.min)newZoom=this._scale.min;else if(newZoom>this._scale.max)newZoom=this._scale.max;this._scale.value=newZoom;let relX=-(this._position.x.value+this._offSetX),relY=-(this._position.y.value+this._offSetY);let oldX=(x+relX)*oldZoom,oldY=(y+relY)*oldZoom,newX=(x+relX)*newZoom,newY=(y+relY)*newZoom;this._position.x.value+=(oldX-newX)/oldZoom;this._position.y.value+=(oldY-newY)/oldZoom}}}Widget.type=new NodeType("Widget","widget",Node.type,Widget);Widget.anchorValues=["top-left","top","top-right","left","center","right","bottom-left","bottom","bottom-right","movable"];Widget.pivotValues=["top-left","top","top-right","left","center","right","bottom-left","bottom","bottom-right"];export class UserInterface extends Node{get component(){return this._component}get background(){return this._background}get color(){return this._color}get resources(){return this._resources}get layers(){return this._layers}get width(){return this._width}get height(){return this._height}get onViewReset(){return this._onViewReset}get style(){return this._style}constructor(name,parent,data={}){super(name,parent,data);this._width=new Number("width",this,2970);this._height=new Number("height",this,2100);this._color=new Color("color",this,"url(#background_color)");this._style=new String("style",this,"dark");this._resources=new NodeSet("resources",this,String.type);this._layers=new NodeSet("layers",this,Widget.type);let width=this._width.value,height=this._height.value,color=this.color.toString(),unitType="mm";if(!this._component){let name=parent.title.value;this._component=new Component("svg",undefined,{id:name,xmlns:"http://www.w3.org/2000/svg",version:"1.1","xmlns:xlink":"http://www.w3.org/1999/xlink",width:width/10+unitType,height:height/10+unitType,viewBox:"0 0 "+width+" "+height})}if(KnowledgeGraph.environment=="browser"){let element=this._component.element,children=element.childNodes,childIndex=0,childCount=children.length;for(childIndex=0;childIndex<childCount;childIndex++){let child=children.item(childIndex);if(child.nodeType!=child.ELEMENT_NODE||!(child.tagName=="defs"||child.tagName=="script")){this._component.element.removeChild(child);childIndex--;childCount--}}let parentElement=data.element||document.body;if(KnowledgeGraph.environment=="browser"&&!parentElement){this._width.value=window.innerWidth;this._height.value=window.innerHeight;console.log(this._width.value,this._height.value)}else{this._width.value=parentElement.clientWidth;this._height.value=parentElement.clientHeight;parentElement.append(element)}this._component.setAttribute("style","position: fixed; "+"top: 0; left: 0; width:100%; height:100%; user-select: none;")}this._onViewReset=[];if(data!=undefined)this.deserialize(data);this._definitions=new Component("defs",this._component);let style=this._style.value=KnowledgeGraph.environment=="browser"?"dark":"light",black="#111111",white="#FFFFFF",color1=style=="light"?white:black,color2=style=="light"?black:white;let background_color=new Component("linearGradient",this._definitions,{id:"background_color"});new Component("stop",background_color,{"stop-color":color1,"stop-opacity":1});let foreground_color=new Component("linearGradient",this._definitions,{id:"foreground_color"});new Component("stop",foreground_color,{"stop-color":color2,"stop-opacity":1});this.style.updated=true;this._background=new Component("rect",this._component,{id:"background",width:width,height:height,fill:"url(#background_color)"});this.resize();if(KnowledgeGraph.environment=="browser"){window.addEventListener("resize",this.resize.bind(this));this._component.element.addEventListener("resize",this.resize.bind(this));window.oncontextmenu=e=>{e.preventDefault()}}}update(forced=false){if(!this._color.updated)this._background.setAttribute("fill",this._color.toString());if(!this._style.updated){let black=new Color("black",undefined,[0,0,0]),white=new Color("white",undefined,[1,1,1]),foregroundNode=this._definitions.children[0].children[0],backgroundNode=this._definitions.children[1].children[0];let color1,color2;switch(this._style.value){case"light":color1=white;color2=black;break;case"dark":color1=black;color2=white;break}new Animation((t=>{let c1=Color.interpolate(color2,color1,t).hex,c2=Color.interpolate(color1,color2,t).hex;foregroundNode.setAttribute("stop-color",c1);backgroundNode.setAttribute("stop-color",c2);console.log(c1)}),undefined,0,1,0,.2,true);if(this.debug)console.log("Switched style to: "+this._style.value)}if(!this._resources.updated)for(let resource of this._resources)new Component("g",this._definitions,{id:resource.name},resource.value);super.update();if(KnowledgeGraph.environment=="browser"){requestAnimationFrame(this.update.bind(this));return false}}resize(){if(KnowledgeGraph.environment=="node"){for(let layer of this._layers)if(layer.enabled)layer.resize(2970,2100);return}let element=this._component.element,width=element.clientWidth,height=element.clientHeight;this.width.value=width;this.height.value=height;this._component.width=width;this._component.height=height;this._component.setAttribute("width",width);this._component.setAttribute("height",height);this._component.setAttribute("viewBox","0 0 "+width+" "+height);this._background.setAttribute("width",width);this._background.setAttribute("height",height);if(this.debug)console.log("Resized: "+width+" x "+height);for(let layer of this._layers)if(layer.enabled)layer.resize(width,height);this.update()}}UserInterface.type=new NodeType("UserInterface","ui",Node.type,UserInterface);export class Graphic extends Widget{get resource(){return this._resource}constructor(name,parent,data){super(name,parent,undefined,Graphic.type);this._resource=new String("resource",this);this._useComponent=new Component("use",this._component);if(data!=undefined)this.deserialize(data)}update(forced=false){if(this._updated&&!forced)return;if(!this._resource.updated){let r=this._resource.value;this._useComponent.setAttribute("href","#"+r);this._useComponent.setAttribute("xlink:href","#"+r)}return super.update()}}Graphic.type=new NodeType("Graphic","graphic",Widget.type,Graphic);export class Text extends Widget{get text(){return this._text}get font(){return this._font}get align(){return this._align}get size(){return this._size}get color(){return this._color}constructor(name,parent,data){super(name,parent,undefined,Text.type);this._text=new String("text",this,undefined,"<text>");this._font=new String("font",this,undefined,"Arial");this._align=new String("align",this,{validValues:["right","center","left"]},"right");this._size=new Number("size",this,undefined,15);this._color=new Color("color",this,"url(#foreground_color)");this._textComponent=new Component("text",this._component);if(data!=undefined)this.deserialize(data)}update(forced=false){if(this._updated&&!forced)return;let c=this._textComponent;if(!this._text.updated)c.content=this._text.value;if(!this._font.updated)c.setAttribute("font_family",this._font.value);if(!this._size.updated)c.setAttribute("font_size",this._size.value);if(!this.color.updated)c.setAttribute("fill",this.color.toString());return super.update()}}Text.type=new NodeType("Text","text",Widget.type,Text);export class TransitMap extends Widget{constructor(name,parent,data){super(name,parent,data);this._map=new Widget("map",this.widgets);let c=this._map.component;this._districtsElement=new Component("g",c,{id:"districts"});this._connectionsElement=new Component("g",c,{id:"connections"});this._stationsElement=new Component("g",c,{id:"stations"});this._infoElement=new Component("g",c,{id:"info"});this._map.pivot.value="center";this._map.anchor.value="movable";let width=this._width.value,height=this._height.value,vmin=width<height?width:height,legendSize=vmin/10,fontFamily="arial";this._linesLegend=new Widget("LinesLegend",this.widgets,{width:legendSize,height:legendSize,anchor:"bottom-left",position:[10,-10],background:"#88888844",radius:10});new Component("text",this._linesLegend.component,{id:"LinesLegendTitle",x:10,y:20,font_family:fontFamily,font_size:15,font_weight:"bold",fill:"url(#foreground_color)"},"Lines (Stakeholders):");this._linesLegendItems=new Component("g",this._linesLegend.component);this._districtsLegend=new Widget("DistrictsLegend",this.widgets,{width:legendSize,height:legendSize,anchor:"bottom-right",position:[-10,-10],background:"#88888844",radius:10});new Component("text",this._districtsLegend.component,{id:"DistrictsLegendTitle",x:10,y:20,font_family:fontFamily,font_size:15,font_weight:"bold",fill:"url(#foreground_color)"},"Districts (Domains):");this._districtsLegendItems=new Component("g",this._districtsLegend.component);let ui=this.ancestor(UserInterface);ui.onViewReset.push(this.resetView.bind(this))}update(forced=false){if(this._updated&&!forced)return;let model=this.ancestor(KnowledgeGraph).model;let fontFamily="Arial";if(forced||!this._updateTime||this._updateTime<=model.updateTime){this._districtsElement.clear();this._connectionsElement.clear();this._stationsElement.clear();this._infoElement.clear();this._districts={};this._districtsList=[];this._stations={};this._stationsList=[];this._connections={};this._connectionsList=[];let districtIndex=0,districtColors=["#ef1de5","#037e8e","#00abcd","#620d7d","#b206f9","#082ebf","#C999D3","#F2E6F4","#EBB3F3","#F8E6FB","#B3C3D4","#E6EBF1","#BFFBFF","#EAFEFF"];for(let d of model.domains){let district={name:d.name,title:d.title.value,description:d.description.value,stations:[],color:districtColors[districtIndex]};district.element=new Component("path",this._districtsElement,{id:district.name,fill:district.color,fill_opacity:.4});for(let c of d.classes)district.stations.push(c.name);this._districts[district.name]=district;this._districtsList.push(district);districtIndex++}for(let c of model.classes){let station={name:c.name,title:c.title.value,description:c.description.value,lines:[],districts:[],connections:{},x:1e3,y:1e3,visible:true};for(let lineName of c.relations.references)station.lines.push(lineName);for(let district of c.domains.references)station.districts.push(district);station.element=new Component("g",this._stationsElement,{id:station.name});new Component("circle",station.element,{r:10,stroke:"url(#foreground_color)",stroke_width:"2",fill:"url(#background_color)"});let text=station.title,lines=text.split("\n"),fontSize=10,lineSeparation=15,lineOffset=-5-lineSeparation*lines.length;let labelShadow=new Component("text",station.element,{font_family:fontFamily,font_size:fontSize,font_weight:"bold",text_anchor:"middle",stroke:"url(#background_color)",stroke_width:2});let label=new Component("text",station.element,{font_family:fontFamily,font_size:fontSize,font_weight:"bold",text_anchor:"middle",fill:"url(#foreground_color)"});for(let lineIndex=0;lineIndex<lines.length;lineIndex++){let tp={x:0,y:lineOffset},line=lines[lineIndex];new Component("tspan",labelShadow,tp,line);new Component("tspan",label,tp,line);lineOffset+=lineSeparation}station.infoElement=new Component("g",this._infoElement);if(KnowledgeGraph.environment=="node")station.infoElement.setAttribute("display","none");let w=200,r=10;text=station.description;lines=text.split("\n");lineOffset=15;new Component("rect",station.infoElement,{x:-w/2,y:0,width:w,height:w/2,rx:r,ry:r,font_family:fontFamily,font_size:fontSize,font_weight:"bold",text_anchor:"middle",fill:"url(#background_color)",stroke:"url(#foreground_color)",stroke_width:2});let description=new Component("text",station.infoElement,{font_family:fontFamily,font_size:fontSize,font_weight:"bold",text_anchor:"middle",fill:"url(#foreground_color)"});for(let lineIndex=0;lineIndex<lines.length;lineIndex++){let tp={x:0,y:lineOffset},line=lines[lineIndex];new Component("tspan",description,tp,line);lineOffset+=lineSeparation}if(KnowledgeGraph.environment=="browser"){let e=station.infoElement;e.enabled=false;e.onclick=station.element.onclick=()=>{e.enabled=!e.enabled;if(e.enabled)console.log(station)}}this._stations[station.name]=station;this._stationsList.push(station)}this._stationsList.sort(((a,b)=>b.lines.length-a.lines.length));let lineIndex=0,lineColors=["#ef1de5","#037e8e","#00abcd","#620d7d","#b206f9","#082ebf","#a59dcc","#582bb1"],lineWidths=[2,2,2,2,2,2,2,2];this._lines={};this._linesList=[];for(let relation of model.relations){let line={name:relation.name,title:relation.title.value,description:relation.description.value,color:lineColors[lineIndex],stations:[],connections:[],width:lineWidths[lineIndex],circular:false};for(let stationName of relation.classes.references)line.stations.push(stationName);line.stations.sort(((a,b)=>this._stations[b].lines.length-this._stations[a].lines.length));this._lines[relation.name]=line;this._linesList.push(line);lineIndex++}this._linesList.sort(((a,b)=>b.stations.length-a.stations.length));this.updateLegends();this.createGrid();this.resetView(KnowledgeGraph.environment=="browser"?.5:0)}this.updateStations();this.updateDistricts();this.updateConnections();return super.update(forced)}createSimpleGrid(columns=5,separation=200){let rows=Math.round(this._stationsList.length/columns),halfWidth=(columns-1)/2,halfHeight=(rows-1)/2,x=-halfWidth,y=-halfHeight;for(let stationName in this._stations){let station=this._stations[stationName];station.x=x*separation;station.y=y*separation;x++;if(x>halfWidth){x=-halfWidth;y++}}}createGrid(rows=5,columns=10,cellSize=100){let grid=[],cx=Math.floor(columns/2),cy=Math.floor(rows/2);for(let x=0;x<columns;x++){grid[x]=[];for(let y=0;y<rows;y++)grid[x][y]=undefined}let remainingStations=[...this._stationsList],stations=[];this._connections={};this._connectionsList=[];while(remainingStations.length>0){let station=remainingStations.shift(),options=[];for(let x=0;x<columns;x++){for(let y=0;y<rows;y++){if(grid[x][y])continue;let dx=cx-x,dy=cy-y,connectionDistance=Math.abs(dx)+Math.abs(dy),value=connectionDistance;let links=[];for(let line of station.lines){let bestStation,bestValue=1e5;for(let previousStation of stations){if(previousStation.lines.includes(line)){let cdx=previousStation.x-x,cdy=previousStation.y-y,connectionDistance=Math.abs(cdx)+Math.abs(cdy);if(bestValue>connectionDistance){bestValue=connectionDistance;bestStation=previousStation}}}if(!bestStation)continue;links.push({station:bestStation.name,line:line});value-=bestValue/10;if(station.districts[0]==bestStation.districts[0])value-=.01}options.push({x:x,y:y,v:value,links:links})}}options.sort(((a,b)=>a.v-b.v));let bestGridPosition=options[0];grid[bestGridPosition.x][bestGridPosition.y]=station;station.gridX=bestGridPosition.x;station.gridY=bestGridPosition.y;for(let link of bestGridPosition.links){let connectionName=station.name+"-"+link.station,connection=this._connections[connectionName];if(!connection){connection={a:station.name,b:link.station,lines:[],width:0,component:new Component("g",this._connectionsElement,{id:connectionName})};this._connections[connectionName]=connection;this._connectionsList.push(connection)}let line=this._lines[link.line];new Component("polyline",connection.component,{id:connectionName+"-"+link.line,stroke:line.color,stroke_width:line.width});connection.width+=line.width}stations.push(station)}let stationIndex=0,maxStation=typeof this.debug=="number"?this.debug:0;for(let station of stations){station.x=1e3;station.y=1e3;station.visible=false;if(maxStation&&++stationIndex>maxStation){station.gridX=station.gridY=undefined;continue}station.x=(station.gridX-cx)*cellSize;station.y=(station.gridY-cy)*cellSize;station.visible=true}}updateStations(){for(let station of this._stationsList){let display=station.visible?undefined:"none";station.element.setAttribute("display",display);if(!station.visible)continue;let transform="translate("+station.x+", "+station.y+")";station.element.setAttribute("transform",transform);station.infoElement.setAttribute("transform",transform)}}updateConnections(){for(let connection of this._connectionsList){let a=this._stations[connection.a],b=this._stations[connection.b],x1=a.x,y1=a.y,x2=b.x,y2=b.y;if(x1==x2&&y1==y2)continue;if(!a.visible)continue;let width=0;for(let lineName of connection.lines)width+=this._lines[lineName].width;let offset=-width/2,ox=y2-y1,oy=-(x2-x1);let l=Math.sqrt(ox*ox+oy*oy);ox/=l;oy/=l;for(let component of connection.component.children){offset+=parseFloat(component.getAttribute("stroke-width"));component.setAttribute("points",x1+ox*offset+","+(y1+oy*offset)+" "+(x2+ox*offset)+","+(y2+oy*offset))}}}updateDistricts(){let districtRadius=50;for(let district of this._districtsList){let points=[];for(let stationName of district.stations){let station=this._stations[stationName];if(station.gridX==undefined)continue;points.push({x:station.x,y:station.y})}if(points.length==0)continue;if(points.length==1)points.push({x:points[0].x+1e-4,y:points[0].y});let pointIndex,pointCount=points.length;let startVertex=0,startingX=points[0].x;for(pointIndex=1;pointIndex<pointCount;pointIndex++){let point=points[pointIndex];if(startingX<=point.x)continue;startVertex=pointIndex;startingX=point.x}let vertex=startVertex,angle,newAngle=1e3,vertexIndex=0,vertexCount=pointCount,vertices=[];for(vertexIndex=0;vertexIndex<vertexCount;vertexIndex++){let ox=points[vertex].x,oy=points[vertex].y;for(pointIndex=0;pointIndex<pointCount;pointIndex++){if(pointIndex==vertex||vertices.includes(pointIndex))continue;let dx=points[pointIndex].x-ox,dy=points[pointIndex].y-oy;if(dx==0&&dy==0)continue;let a=Math.atan2(dy,dx);if(angle!=undefined&&a<angle)a+=Math.PI*2;if(newAngle>a){newAngle=a;vertex=pointIndex}}vertices.push(vertex);angle=newAngle;newAngle=1e3;if(vertex==startVertex)break}vertices.push(startVertex);vertices.unshift(startVertex);vertexCount=vertices.length;let lines=[],lineIndex=0,lineCount=vertexCount-1;for(lineIndex=0;lineIndex<lineCount;lineIndex++){let v1=points[vertices[lineIndex]],v2=points[vertices[lineIndex+1]];lines.push({p1:v1,p2:v2,angle:Math.atan2(v2.y-v1.y,v2.x-v1.x)})}let offset=50,path="";for(lineIndex=0;lineIndex<lineCount;lineIndex++){let l=lines[lineIndex],l2=lines[(lineIndex+1)%lineCount],dx1=Math.sin(l.angle)*districtRadius,dy1=-Math.cos(l.angle)*districtRadius,dx2=Math.sin(l2.angle)*districtRadius,dy2=-Math.cos(l2.angle)*districtRadius,x1=l.p1.x+dx1,y1=l.p1.y+dy1,x2=l.p2.x+dx1,y2=l.p2.y+dy1,x3=l.p2.x+dx2,y3=l.p2.y+dy2;if(lineIndex==0)path+="M "+x1+" "+y1+" ";path+="L "+x2+" "+y2+" ";path+="A "+districtRadius+" "+districtRadius+" 0 0 1 "+x3+" "+y3+" "}district.element.setAttribute("d",path+"Z")}}updateLegends(){let fontFamily="arial";this._linesLegendItems.clear();let lineIndex=0;this._linesLegend.width.value=200;this._linesLegend.height.value=30+20*this._linesList.length;for(let line of this._linesList){new Component("rect",this._linesLegend.component,{fill:line.color,x:10,y:30+20*lineIndex,width:20,height:10});new Component("text",this._linesLegend.component,{id:line.name+"legend",fill:"url(#foreground_color)",x:40,y:40+20*lineIndex,font_family:fontFamily,font_size:14},line.title);lineIndex++}this._districtsLegendItems.clear();let districtIndex=0;this._districtsLegend.width.value=200;this._districtsLegend.height.value=30+20*this._districtsList.length;for(let district of this._districtsList){new Component("rect",this._districtsLegendItems,{fill:district.color,x:10,y:30+20*districtIndex,width:20,height:10});new Component("text",this._districtsLegendItems,{id:district.name+"legend",fill:"url(#foreground_color)",x:40,y:40+20*districtIndex,font_family:fontFamily,font_size:14},district.title);districtIndex++}}resetView(duration=.5){let v=1e4,minX=v,maxX=-v,minY=v,maxY=-v,border=100;for(let station of this._stationsList){if(!station.visible)continue;if(minX>station.x)minX=station.x;if(maxX<station.x)maxX=station.x;if(minY>station.y)minY=station.y;if(maxY<station.y)maxY=station.y}minX-=border;minY-=border;maxX+=border;maxY+=border;let scaleX=this._width.value/(maxX-minX),scaleY=this._height.value/(maxY-minY),scale=scaleX<scaleY?scaleX:scaleY,cX=(minX+(maxX-minX)/2)*scale,cY=(minY+(maxY-minY)/2)*scale;let map=this._map,p=map.position.getValues(),s=map.scale.value;if(duration>0){new Animation((t=>{this._map.scale.value=(1-t)*s+t*scale;this._map.position.setValues((1-t)*p.x+t*-cX,(1-t)*p.y+t*-cY)}),undefined,0,1,0,duration,true)}else{this._map.scale.value=scale;this._map.position.setValues(-cX,-cY)}}}TransitMap.type=new NodeType("TransitMap","transit_map",Widget.type,TransitMap);export class StyleSwitcher extends Widget{constructor(name,parent,data){super(name,parent,data,StyleSwitcher.type);this._value=new Boolean("value",this,false);if(KnowledgeGraph.environment!=="browser")return;this.width.value=80;this.height.value=100;this._backgroundColor.hex="#00000000";let cx=40,cy=40,ir=20,or=30,stroke=5;for(let angle=0;angle<360;angle+=45){let a=angle*Math.PI/180,s=Math.sin(a),c=Math.cos(a);new Component("line",this.component,{x1:cx,x2:cy+c*or,y1:cx,y2:cy+s*or,stroke:"url(#foreground_color)",stroke_width:stroke,stroke_linecap:"round"})}let circle=new Component("circle",this.component,{cx:cx,cy:cy,r:20,fill:"url(#background_color)",stroke:"url(#foreground_color)",stroke_width:stroke});let circle2=new Component("circle",this.component,{cx:cx*5/4,cy:cy,r:0,fill:"url(#background_color)",stroke:"url(#foreground_color)",stroke_width:stroke});new Component("text",this.component,{x:40,y:100,stroke_linecap:"round",text_anchor:"middle",font_family:"Arial",font_size:14,fill:"url(#foreground_color)"},"Switch Style");circle.animations["switch"]=new Animation(circle,"r",ir,or,0,.25,false);circle2.animations["switch"]=new Animation(circle2,"r",0,20,0,.25,false);function changed(){circle.animations["switch"].play(1,this._value.value);circle2.animations["switch"].play(1,this._value.value);this._value.value=!this._value.value;if(this._onChange)this._onChange(this);this.ancestor(UserInterface).style.value=this._value.value?"light":"dark"}this._component.onclick=changed.bind(this)}}StyleSwitcher.type=new NodeType("StyleSwitcher","style-switcher",Widget.type,StyleSwitcher);export class ViewResetter extends Widget{constructor(name,parent,data){super(name,parent,data,ViewResetter.type);if(KnowledgeGraph.environment!=="browser")return;this.width.value=80;this.height.value=100;this._backgroundColor.hex="#00000000";new Component("rect",this.component,{x:10,y:10,width:60,height:60,fill:"url(#background_color)",stroke:"url(#background_color)",stroke_width:5});new Component("polyline",this.component,{fill:"none",stroke_linecap:"round",stroke:"url(#foreground_color)",stroke_width:5,points:[10,30,10,10,30,10]});new Component("polyline",this.component,{fill:"none",stroke_linecap:"round",stroke:"url(#foreground_color)",stroke_width:5,points:[70,30,70,10,50,10]});new Component("polyline",this.component,{fill:"none",stroke_linecap:"round",stroke:"url(#foreground_color)",stroke_width:5,points:[10,50,10,70,30,70]});new Component("polyline",this.component,{fill:"none",stroke_linecap:"round",stroke:"url(#foreground_color)",stroke_width:5,points:[50,70,70,70,70,50]});let circle=new Component("circle",this.component,{cx:40,cy:40,r:20,stroke:"url(#foreground_color)",stroke_width:5,fill:"none"});new Component("text",this.component,{x:40,y:100,text_anchor:"middle",font_family:"Arial",font_size:14,fill:"url(#foreground_color)"},"Reset View");circle.animations["switch"]=new Animation(circle,"r",0,20,0,.25,false);function changed(){circle.animations["switch"].play(1);if(this._onChange)this._onChange(this);let ui=this.ancestor(UserInterface);for(let callback of ui.onViewReset)callback()}this._component.onclick=changed.bind(this)}}ViewResetter.type=new NodeType("ViewResetter","view-resetter",Widget.type,ViewResetter);export class KnowledgeGraph extends Node{get title(){return this._title}get model(){return this._model}get ui(){return this._ui}constructor(data={}){const instanceCount=KnowledgeGraph.instances.length;super("KnowledgeGraph"+(instanceCount>0?instanceCount:""));if(instanceCount==0)console.log("Initializing "+KnowledgeGraph.name+" Version: "+KnowledgeGraph.version+" (Environment: "+KnowledgeGraph.environment+")");KnowledgeGraph.instances.push(this);this._title=new String("title",this,data.title||this.name);this._model=new Model("model",this);this._ui=new UserInterface("ui",this);if(data!=undefined){if(typeof data!="object")throw Error("Invalid data for "+this.id);this.deserialize(data)}this.update()}static init(data={}){if(typeof data=="object")return new KnowledgeGraph(data);else if(typeof data=="string"){fetch(data).then((response=>response.text())).then((data=>{data=data.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"");data=data.replace(/\,\s*\n(\s*[}|\]])/gm,"\n$1");let jsonData=JSON.parse(data);new KnowledgeGraph(jsonData)}))}else throw Error("Invalid data for InteroperabilityMap initialization")}}KnowledgeGraph.type=new NodeType("KnowledgeGraph","root",Node.type,KnowledgeGraph);KnowledgeGraph.version="0.7.0";KnowledgeGraph.instances=[];KnowledgeGraph.environment=[typeof window,typeof document].includes("undefined")?"node":"browser";